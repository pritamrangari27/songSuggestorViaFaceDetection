<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Song Suggestor Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'Montserrat', sans-serif;
  margin: 0;
  background-color: #121212;
  color: #fff;
  overflow-x: hidden;
  cursor: default; /* normal cursor */
}

.sidebar {
  position: fixed; top: 0; left: 0; width: 240px; height: 100%; background: #191414;
  padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.5);
}
.sidebar h2 { color: #1DB954; margin-bottom: 20px; }
.sidebar ul { list-style: none; padding: 0; }
.sidebar ul li { margin: 15px 0; position: relative; }
.sidebar ul li a { color: #B3B3B3; text-decoration: none; font-size: 1rem; cursor: pointer; }
.sidebar ul li a:hover { color: #1DB954; }

#sidebarChat::after {
  content: '';
  display: none;
  width: 10px; height: 10px;
  background: red;
  border-radius: 50%;
  position: absolute;
  top: 12px; right: 12px;
}
#sidebarChat.new-message::after { display: block; }

.main { margin-left: 260px; padding: 20px; }
.top-bar { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px; }
.user-info { display: flex; align-items: center; background: #282828; padding: 10px 15px; border-radius: 12px; cursor: pointer; }
.user-info .avatar { width: 32px; height: 32px; background: #1DB954; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-weight: bold; color: #000; }

.grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
.card { background: #191414; border-radius: 16px; padding: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); }

.modal {
  position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
  background: #191414; border-radius: 16px; text-align: center; z-index: 10000;
  padding: 20px; width: 400px; max-width: 95%; box-shadow: 0 0 15px #1DB954;
}
.modal.video-modal { width: 420px; }
.modal.song-modal { width: 600px; }
.modal.medium { width: 450px; }

.modal video, .modal img { border-radius: 12px; width: 100%; border: 3px solid #1DB954; }
.modal button { margin-top: 10px; padding: 8px 12px; border: none; border-radius: 6px; background: #1DB954; color: #000; font-weight: bold; cursor: pointer; }
.modal button:hover { background: #1ed760; }
.close-btn { position: absolute; top: 10px; right: 10px; border: none; border-radius: 50%; width: 30px; height: 30px; background: #1DB954; color: #000; font-weight: bold; cursor: pointer; }

#song-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 20px; }
#song-grid iframe { width: 100%; height: 80px; border-radius: 12px; border: none; }

#chat-box {
  height: 400px;
  overflow-y: auto;
  margin: 10px 0;
  background: #121212;
  padding: 10px;
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.chat-message {
  padding: 10px 14px;
  border-radius: 20px;
  max-width: 75%;
  word-wrap: break-word;
}
.chat-sent { background: #1DB954; color: #000; align-self: flex-end; text-align: right; border-bottom-right-radius: 4px; }
.chat-received { background: #282828; color: #fff; align-self: flex-start; text-align: left; border-bottom-left-radius: 4px; }

input, select { padding: 6px; border-radius: 6px; border: none; margin: 0 auto 10px auto; width: 150px; display:block; }
button { cursor: pointer; }
</style>
</head>
<body>

<div class="sidebar">
  <h2>Song Suggestor</h2>
  <ul>
    <li><a id="sidebarDashboard">Dashboard</a></li>
    <li><a id="sidebarChat">Chat</a></li>
    <li><a id="sidebarSettings">Settings</a></li>
    <li><a href="{{ url_for('logout') }}">Logout</a></li>
  </ul>
</div>

<div class="main">
  <div class="top-bar">
    <div class="user-info" id="openProfile">
      <span class="avatar">{{ username[0]|upper }}</span>
      <span class="username">{{ username }}</span>
    </div>
  </div>
  <div class="grid">
    <div class="card" id="welcome-card">
      <h2>Welcome, {{ username }}!</h2>
      <p>This is your Mood Detection Dashboard.</p>
      <button id="detectMoodBtn">Detect Mood</button>
    </div>
  </div>
</div>

<script>
let currentUsername = "{{ username }}";
let currentEmail = "{{ email }}";
let currentGender = "{{ gender }}";
let currentAge = "{{ age }}";

function closeAllPopups() {
  document.querySelectorAll('.modal').forEach(modal => {
    const video = modal.querySelector("video");
    if(video && video.srcObject) video.srcObject.getTracks().forEach(t=>t.stop());
    modal.remove();
  });
}

function createPopup(title, innerHTML, extraClass="") {
  closeAllPopups();
  const modal = document.createElement("div"); modal.className="modal "+extraClass;
  modal.innerHTML = `<button class="close-btn">X</button><h2>${title}</h2>${innerHTML}`;
  document.body.appendChild(modal);
  modal.querySelector(".close-btn").addEventListener("click", ()=>modal.remove());
  return modal;
}

// --- Profile Info (Read Only) ---
document.getElementById("openProfile").addEventListener("click", ()=>{
  createPopup("Profile Info", `
    <p><b>Username:</b> ${currentUsername}</p>
    <p><b>Email:</b> ${currentEmail}</p>
    <p><b>Gender:</b> ${currentGender || "None"}</p>
    <p><b>Age:</b> ${currentAge || "None"}</p>
  `, "medium");
});

// --- Settings (Editable except Username) ---
// --- Settings (Editable except Username) ---
document.getElementById("sidebarSettings").addEventListener("click", ()=>{
  const modal = createPopup("Settings", `
    <input type="text" value="${currentUsername}" readonly>
    <input type="text" id="settingsEmail" value="${currentEmail}">
    <input type="text" id="settingsGender" value="${currentGender}">
    <input type="number" id="settingsAge" value="${currentAge}">
    <button id="saveSettingsBtn">Save</button>
  `, "medium");

  modal.querySelector("#saveSettingsBtn").addEventListener("click", ()=>{
    const email = modal.querySelector("#settingsEmail").value;
    const gender = modal.querySelector("#settingsGender").value;
    const age = modal.querySelector("#settingsAge").value;

    fetch("/update_profile",{
      method:"POST", 
      headers:{"Content-Type":"application/x-www-form-urlencoded"}, 
      body:`email=${encodeURIComponent(email)}&gender=${encodeURIComponent(gender)}&age=${encodeURIComponent(age)}`
    }).then(()=>{
      // Update JS variables dynamically
      currentEmail = email;
      currentGender = gender;
      currentAge = age;
      modal.remove(); // close settings popup
      
    });
  });
});


// --- Chat ---
function showUnreadDot(flag) {
  document.getElementById("sidebarChat").classList.toggle("new-message", flag);
}

document.getElementById("sidebarChat").addEventListener("click", () => {
  showUnreadDot(false);

  const modal = createPopup("Chat", `
    <select id="chat-users"></select>
    <div id="chat-box"></div>
    <div style="display:flex; margin-top:5px;">
      <input type="text" id="chat-input" placeholder="Type message..." style="flex:1; border-radius:20px; padding:10px;">
      <button id="chat-send" style="margin-left:10px; border-radius:20px;">Send</button>
    </div>
  `);

  const chatBox = modal.querySelector("#chat-box");
  let currentChatUser = null;

  // Load all users except current
  function loadChatUsers() {
    fetch("/users/list", { credentials: 'same-origin' })
      .then(r => r.json())
      .then(users => {
        const sel = modal.querySelector("#chat-users");
        sel.innerHTML = "";
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.innerText = "Select User";
        sel.appendChild(defaultOption);
        users.forEach(u => {
          const opt = document.createElement("option");
          opt.value = u;
          opt.innerText = u;
          sel.appendChild(opt);
        });
      });
  }

  // Load messages with selected user
  function loadMessages() {
    if (!currentChatUser) return;
    fetch(`/chat/fetch?user=${currentChatUser}`, { credentials: 'same-origin' })
      .then(r => r.json())
      .then(msgs => {
        chatBox.innerHTML = msgs.map(m => {
          const isSent = m.from === currentUsername;
          const cls = isSent ? "chat-sent" : "chat-received";
          const displayName = isSent ? "You" : m.from;
          return `<div class="chat-message ${cls}"><div><b>${displayName}</b></div><div>${m.text}</div></div>`;
        }).join("");
        chatBox.scrollTop = chatBox.scrollHeight;
      });
  }

  // On user select
modal.querySelector("#chat-users").addEventListener("change", e => {
    currentChatUser = e.target.value;
    chatBox.innerHTML = ""; // Clear previous messages
    if(currentChatUser) loadMessages();
});


  // Send message
  modal.querySelector("#chat-send").addEventListener("click", () => {
    const text = modal.querySelector("#chat-input").value.trim();
    if (!text || !currentChatUser) return alert("Select a user and type a message.");
    fetch("/chat/send", {
      method: "POST",
      credentials: 'same-origin',
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ to: currentChatUser, text })
    }).then(() => {
      modal.querySelector("#chat-input").value = "";
      loadMessages();
    });
  });

  loadChatUsers();
  // Auto-refresh chat every 3s
  setInterval(loadMessages, 3000);
});


// --- Mood Detection ---
document.getElementById("detectMoodBtn").addEventListener("click", ()=>{
  function startMoodFlow(){
    closeAllPopups();
    const modal = createPopup("Detecting Mood", `
      <div id="camera-box">
        <video autoplay id="webcam-video"></video>
      </div>
      <button id="captureBtn">Capture Face</button>
      <div id="mood-result"></div>
    `, "video-modal");

    const videoEl = modal.querySelector("#webcam-video");
    const captureBtn = modal.querySelector("#captureBtn");
    const moodResult = modal.querySelector("#mood-result");
    const cameraBox = modal.querySelector("#camera-box");

    navigator.mediaDevices.getUserMedia({video:true}).then(stream=>{
      videoEl.srcObject = stream;

      captureBtn.addEventListener("click", ()=>{
        const canvas=document.createElement("canvas");
        canvas.width=videoEl.videoWidth; canvas.height=videoEl.videoHeight;
        const ctx=canvas.getContext("2d"); ctx.drawImage(videoEl,0,0);
        const dataURL=canvas.toDataURL("image/jpeg");

        // stop camera
        if(stream) stream.getTracks().forEach(t=>t.stop());

        // replace video with captured image
        cameraBox.innerHTML = `<img src="${dataURL}">`;

        fetch("/predict",{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({image:dataURL})})
          .then(r=>r.json())
          .then(res=>{
            if(!res.emotion || res.emotion==="No face detected"){
              moodResult.innerHTML="<p style='color:red'>No face detected.</p><button id='retryBtn'>Retry</button>";
              document.getElementById("retryBtn").addEventListener("click", ()=> startMoodFlow());
            } else {
              moodResult.innerHTML=`<p>Your mood: <b>${res.emotion}</b></p><button id="suggestBtn">Suggest Songs</button>`;
              modal.querySelector("#suggestBtn").addEventListener("click", ()=>openSongPopup(res.emotion));
            }
          });
      });
    }).catch(()=>{ alert("Webcam access denied."); modal.remove(); });
  }
  startMoodFlow();
});

// --- Songs ---
function openSongPopup(mood){
  closeAllPopups();
  const modal = createPopup(`Your Mood: ${mood}`, `<div id="song-grid"></div>`, "song-modal");
  const songGrid = modal.querySelector("#song-grid");

  fetch("/songs",{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({mood})})
    .then(r=>r.json()).then(res=>{
      if(!res.songs || res.songs.length===0){
        songGrid.innerHTML="<p style='color:gray;'>No songs found.</p>"; return;
      }
      res.songs.slice(0,5).forEach(track=>{
        const iframe=document.createElement("iframe"); iframe.src=track.url; songGrid.appendChild(iframe);
      });
    });
}
// --- Chat click handler ---
document.getElementById("sidebarChat").addEventListener("click", () => {
  if (!isLoggedIn) {
    // Create a small login prompt modal
    closeAllPopups(); // remove any existing popups
    const modal = document.createElement("div");
    modal.className = "modal medium";
    modal.innerHTML = `
      <button class="close-btn">X</button>
      <h2>Login Required</h2>
      <p>You must login to use chat!</p>
      <button id="goLoginBtn">Login</button>
    `;
    document.body.appendChild(modal);

    // Close modal button
    modal.querySelector(".close-btn").addEventListener("click", () => modal.remove());

    // Redirect to login page
    modal.querySelector("#goLoginBtn").addEventListener("click", () => {
      window.location.href = "/login";
    });

    return;
  }

  // Existing chat modal code here for logged-in users
});

</script>
</body>
</html>
